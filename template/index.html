<!DOCTYPE html>
<html>
  <head>
    <title>Counter</title>
    <link rel="shortcut icon" href="/static/icon.png" />
    <link rel="stylesheet" type="text/css" href="/static/index.css" />
    <script
      src="/static/jquery-3.5.1.min.js"
      integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
      crossorigin="anonymous"
    ></script>
  </head>
  <body onload="start()">
    <!-- UI layout -->
    <div class="main-container">
      <div>
        <div class="menu">
          <a class="menu-item" href="/"><h3>Home</h3></a>
          <a class="menu-item" href="/show"><h3>Show</h3></a>
          <div class="btn btn-openwindow">打开新窗口</div>
        </div>
      </div>
      <!-- <div class="counter"></div>
      <div class="btn-row">
        <div class="btn btn-incr">+1</div>
        <div class="btn btn-decr">-1</div>
      </div> -->
      <div class="btn-row">
        <div class="btn btn-folder">显示目录</div>
        <div class="btn btn-file">显示文件</div>
        <div class="btn btn-all">显示所有</div>
      </div>
      <h3>目录</h3>
      <div class="note-container">
        <div class="path-container"></div>
        <div class="content-container">
          <p class="file-content"></p>
        </div>
      </div>
    </div>

    <!-- Connect UI actions to Go functions -->
    <script>
      const counter = document.querySelector(".counter");
      const pathList = document.querySelector(".path-container");

      const btnIncr = document.querySelector(".btn-incr");
      const btnDecr = document.querySelector(".btn-decr");
      const btnFolder = document.querySelector(".btn-folder");
      const btnFile = document.querySelector(".btn-file");
      const btnAll = document.querySelector(".btn-all");

      const btnOpenWindow = document.querySelector(".btn-openwindow");

      const fileContent = document.querySelector(".file-content");

      // We use async/await because Go functions are asynchronous
      const render = async () => {
        counter.innerText = `Count: ${await window.counterValue()}`;
      };

      const toDom = (str) => {
        var dom,
          tmp = document.createElement("div");
        tmp.innerHTML = str;
        dom = tmp.children[0];
        return dom;
      };
      String.prototype.endWith = function (s) {
        var d = this.length - s.length;
        return d >= 0 && this.lastIndexOf(s) == d;
      };
      const appendToPathList = (str) => {
        var name = str.replace(/^.*[\\\/]/, "");
        var filename = name.replace(".md", "");
        var pathType = "path-file";

        // if (name.endWith(".md")) {
        //   pathType = "path-folder";
        // }
        if (name == filename) {
          pathType = "path-folder";
        }

        pathList.appendChild(
          toDom(
            '<div class="path-name-row ' +
              pathType +
              '"><div class="path-name" title="' +
              str +
              '"">' +
              filename +
              "</div></div> "
          )
        );
      };

      btnFile.addEventListener("click", async () => {
        var file = await currentFile();
        fileContent.innerText = file;
      });

      //   btnIncr.addEventListener("click", async () => {
      //     await counterAdd(1); // Call Go function
      //     render();
      //   });

      //   btnDecr.addEventListener("click", async () => {
      //     await counterAdd(-1); // Call Go function
      //     render();
      //   });

      btnFolder.addEventListener("click", async () => {
        folders = await showPath("folder"); // Call Go function
        pathList.innerText = "";
        folders.map((f) => appendToPathList(f));
      });

      btnFile.addEventListener("click", async () => {
        folders = await showPath("file");
        pathList.innerText = "";
        folders.map((f) => appendToPathList(f));
      });

      btnAll.addEventListener("click", async () => {
        folders = await showPath("all"); // Call Go function
        pathList.innerText = "";
        folders.map((f) => appendToPathList(f));
      });
      btnOpenWindow.addEventListener("click", async () => {
        await openWindow(""); // Call Go function
      });

      // 默认显示文件路径
      showPath("file").then((files) => {
        pathList.innerText = "";
        files.map((f) => appendToPathList(f));
      });

      // 获取并显示当前文档内容
      currentFile().then((file) => {
        fileContent.innerText = file;
      });

      // 点击路径时处理
      $(document).on("click", ".path-name", async (event) => {
        var target = $(event.target);

        $(".path-name-row").css("background", "white");
        target.parent().css("background", "red");

        var filename = target.attr("title");
        if (showFile != undefined) {
          await openWindow(filename);
          currentFile().then((file) => {
            fileContent.innerText = file;
          });
        }
      });

      render();
    </script>
  </body>
</html>
